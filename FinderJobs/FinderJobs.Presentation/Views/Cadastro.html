<div class="row">
    <form name="sentMessage" id="formCadastro" novalidate action="Acesso/Cadastrar" method="post">
        <div class="row">
            <div class="col-md-10">
                <div class="row">
                    <div class="col-md-12">
                        <input type="hidden" value="" name="Usuario.Id" id="Usuario_Id">
                        <input type="hidden" value="" name="Usuario.Tipo" id="Usuario_Tipo">

                        <div class="col-md-6 form-group">
                            Nome<br />
                            <input type="text" name="Usuario.Nome" id="Usuario_Nome" class="form-control" />
                        </div>
                        <div class="col-md-3 form-group" id="dvCelular">
                            Celular<br />
                            <input type="text" name="Usuario.Celular" id="Usuario_Celular" class="form-control" />
                        </div>
                        <div class="col-md-3 form-group">
                            CPF/CNPJ<br />
                            <input type="text" name="Usuario.CpfCnpj" id="Usuario_CpfCnpj" class="form-control" />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="col-md-6 form-group">
                            Email<br />
                            <input type="text" name="Usuario.Email" id="Usuario_Email" class="form-control" />
                        </div>
                        <div class="col-md-3 form-group" id="dvSenha">
                            Senha<br />
                            <input type="password" name="Usuario.Senha" id="Usuario_Senha" class="form-control" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <img src="../images/icone-usuario.png" height="120" width="100" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="col-md-2 form-group">
                    Cep<br />
                    <input type="text" name="Usuario.EnderecoCep" id="Usuario_EnderecoCep" class="form-control" />
                </div>
                <div class="col-md-6 form-group">
                    Logradouro<br />
                    <input type="text" name="Usuario.EnderecoLogradouro" id="Usuario_EnderecoLogradouro" class="form-control" />
                </div>
                <div class="col-md-2 form-group">
                    Número<br />
                    <input type="text" name="Usuario.EnderecoNumero" id="Usuario_EnderecoNumero" class="form-control" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="col-md-5 form-group">
                    Bairro<br />
                    <input type="text" name="Usuario.EnderecoBairro" id="Usuario_EnderecoBairro" class="form-control" />
                </div>
                <div class="col-md-3 form-group">
                    Cidade<br />
                    <input type="text" name="Usuario.EnderecoCidade" id="Usuario_EnderecoCidade" class="form-control" />
                </div>
                <div class="col-md-2 form-group">
                    UF<br />
                    <input type="text" name="Usuario.EnderecoUF" id="Usuario_EnderecoUF" class="form-control" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="col-md-2" id="dvPago">
                    Pago: <br />
                    <input data-toggle="confirmation" id="btnPago" type="checkbox" name="Usuario.Pago" value="Usuario.Pago" data-off-text="Não" data-on-text="Sim" checked="checked" class="BSswitch">
                </div>
                <div class="form-group col-sm-2" style="display: none" id="dvValor">
                    Valor: <br />
                    <input disabled type="text" name="Usuario.Valor" id="Usuario_Valor" class="form-control" />
                </div>
                <div class="form-group col-sm-2" style="display: none" id="dvAnonimo">
                    Anônimo: <br />
                    <input id="btnAnonimo" type="checkbox" name="Usuario.Anonimo" value="Usuario.Anonimo" data-off-text="Não" data-on-text="Sim" checked="checked" class="BSswitch">
                </div>
                <div class="form-group col-sm-3" style="display: none" id="dvUpload">
                    <br />
                    <input type="file" id="btnAdicionarArquivo">
                </div>
                <div class="form-group col-sm-3" id="dvDownload">

                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="col-lg-4">
                    <br />
                    <div class="input-group">
                        <input id="txtHabilidadeCadastro" autocomplete="false" type="text" class="form-control" placeholder="Habilidade...">
                        <span class="input-group-btn">
                            <button id="btnAddHabilidade" class="btn btn-secondary" type="button">Add</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="form-group col-lg-4">
                    <div class="dropdown">
                        <button id="dropdownCadastro" style="display:none" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                            Habilidades Lista
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" id="HabilidadesSugestoes"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="col-lg-12" id="dvHabilidadesLista">
                </div>
            </div>
        </div>
    </form>
</div>

<script>

    function setHeader(xhr) {
        xhr.setRequestHeader('Authorization', 'bearer ' + localStorage.getItem('token'));
    }

    function CarregaTipo(tipo) {
        $('#Usuario_Tipo').val(tipo);

        //candidato
        if (tipo == 'Candidato') {
            $('#dvCelular').fadeIn();
            EsconderExtras();

            $('#dvUpload').prepend('Adicionar Currículo:');
            $('#Usuario_Valor').val('R$ 100,00');
        }

            //empresa
        else {
            $('#dvCelular').hide();
            EsconderExtras();
            $('#dvUpload').prepend('Anexar "Vaga":');
            $('#Usuario_Valor').val('R$ 1.000,00');
        }

        if ($('#Usuario_Id').val() != null && $('#Usuario_Id').val() != '') {
            $('#dvSenha').hide();
            $('#Usuario_Email').prop('disabled', true);
            CarregarTodosArquivos($('#Usuario_Id').val());
        }
        
        $("#modalCadastro").modal();
    }

    $('#btnPago').bootstrapSwitch('state', false);
    $('#btnPago').on('switchChange.bootstrapSwitch', function () {

        // usar notify

        if ($('#btnPago').bootstrapSwitch('state') == true) {
            $('#btnAnonimo').bootstrapSwitch('state', false);

            Pago(true);

            $('#btnAdicionarArquivo').filestyle({
                buttonText: ' ',
                buttonName: 'btn-info'
            });
        }
        else {
            Pago(false);
        }
    });

    $("#Usuario_EnderecoCep").change(function () {
        buscarEndereco();
    });

    $("#Usuario_Email").change(function () {
        var email = $('#Usuario_Email').val();
        var regexEmail = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

        if (regexEmail.test(email)) {
            $.get("../Acesso/UsuarioDisponivel?email=" + email, function (data) {
                if (!data.sucesso) {
                    Notify('Não disponível, este email já foi cadastrado', null, null, 'danger');
                    $("#Usuario_Email").focus();
                }
            }).fail(function (result) {
                Notify('Erro ao validar email ' + result, null, null, 'danger');
            });
        }
        else
            Notify('Email inválido ', null, null);
    });

    function buscarEndereco() {
        var cep = $('#Usuario_EnderecoCep').val();
        if (cep != null && cep != undefined && cep.length > 7) {
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': cep }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    var lat = results[0].geometry.location.lat();
                    var lng = results[0].geometry.location.lng();

                    geocoder.geocode({ latLng: results[0].geometry.location }, function (results, status) {
                        if (status == google.maps.GeocoderStatus.OK) {

                            $('#Usuario_EnderecoLogradouro').val('');
                            $('#Usuario_EnderecoBairro').val('');
                            $('#Usuario_EnderecoCidade').val('');
                            $('#Usuario_EnderecoUF').val('');
                            console.log(results);
                            $.each(results, function (index, value) {
                                $.each(value.types, function (index2, tipo) {

                                    if (tipo == "street_address" && value.address_components[1]) {
                                        //Logradouro
                                        $('#Usuario_EnderecoLogradouro').val(value.address_components[1].long_name);
                                        //Bairro
                                        $('#Usuario_EnderecoBairro').val(value.address_components[2].short_name);
                                    }
                                    else if (tipo == 'route') {
                                        //Logradouro
                                        $('#Usuario_EnderecoLogradouro').val(logradouro = value.address_components[0].long_name);
                                        //Bairro
                                        $('#Usuario_EnderecoBairro').val(value.address_components[2].short_name);
                                    }

                                    //Cidade
                                    if (tipo == "administrative_area_level_2")
                                        $('#Usuario_EnderecoCidade').val(value.address_components[0].short_name);
                                    //UF
                                    if (tipo == "administrative_area_level_1")
                                        $('#Usuario_EnderecoUF').val(value.address_components[0].short_name);

                                });
                            });
                        }
                    })
                }
            });
        }
    }

    $("#txtHabilidadeCadastro").keyup(function () {
        var parametro = $('#txtHabilidadeCadastro').val();
        if (parametro != undefined && parametro != '') {
            $.get("../Habilidade/Index?parametro=" + parametro, function (data) {
                if (data.length > 0) {
                    var html = '';
                    $.each(data, function (index, value) {
                        html += "<li><a href=\"javascript: SelecionarDDL(\'" + value.Id + "_" + value.Nome + "\');\">" + value.Nome + "</a></li>";
                    });
                    $('#HabilidadesSugestoes').html(html);
                    $('#dropdownCadastro').dropdown('toggle');
                    $("#txtHabilidadeCadastro").focus();
                }
            });
        }
    });

    SelecionarDDL = function (selecionado) {
        var id = selecionado.split('_')[0];
        var habilidade = selecionado.split('_')[1];
        if (!HabilidadeExiste(habilidade)) {
            var html = '<span id="habilidade_' + id + '" style="margin: 1px; padding: 4px;" class="alert-info">'
                           + habilidade + '<a data-toggle="confirmation2" style="color:red" href="#" id="'
                           + habilidade + '" onclick="RemoverHabilidade(this);return false;"><i class="fa fa-times"> </i></a></span>';
            $('#dvHabilidadesLista').append(html);
            $('#txtHabilidadeCadastro').val('');
        }
        else
            Notify('Você já adicionou esta habilidade', null, null);
    }

    function HabilidadeExiste(habilidade) {
        var existe = false;
        var lista = $('#dvHabilidadesLista span');
        $.each(lista, function (index, value) {
            if (value.innerText.toLowerCase() == habilidade.toLowerCase())
                existe = true;
        });

        return existe;
    }

    $("#btnAddHabilidade").click(function () {
        if (PodeAdicionarHabilidade()) {
            var habilidade = $('#txtHabilidadeCadastro').val();
            if (habilidade.length > 0) {
                if (!HabilidadeExiste(habilidade)) {
                    var html = '<span id="habilidade_' + habilidade + '" style="margin: 1px; padding: 4px;" class="alert-info">' + habilidade
                        + '<a style="color:red" href="#" id="' + habilidade + '" onclick="RemoverHabilidade(this);return false;"><i class="fa fa-times"> </i></a></span>';
                    $('#dvHabilidadesLista').append(html);
                }
                else
                    Notify('Você já adicionou esta habilidade', null, null);

                $('#txtHabilidadeCadastro').val('');
            }
            else
                Notify('Digite uma habilidade, por favor', null, null);
        }
        else
            Notify('Você atingiu o limite para adicionar habilidades', null, null);

    });

    function RemoverHabilidade(habilidade) {
        $(habilidade).parent().remove();
    }

    function PodeAdicionarHabilidade() {
        var pago = $("#btnPago").bootstrapSwitch('state');
        var quantidadeAtual = $('#dvHabilidadesLista span').length;
        if (pago && quantidadeAtual < 50) {
            return true;
        }
        if (quantidadeAtual < 20) {
            return true;
        }
        return false;
    }

    function EsconderExtras() {        
        $('#dvValor').hide();
        $('#dvAnonimo').hide();
        $('#dvUpload').hide();
    }

    function Pago(sim) {
        $('#dvValor').hide();
        $('#dvAnonimo').hide();
        $('#dvUpload').hide();
        $('#dvUpload').hide();

        if (sim) {
            $('#dvValor').fadeIn();
            $('#dvAnonimo').fadeIn();
        }

        // arquivo
        if (true) {
            $('#dvUpload').fadeIn();
        }
        else {
            $('#dvUpload').fadeIn();
        }
    }

    var usuario;
    $(function () {
        $("#btnCadastrar").click(function () {
            var valido = true;
            var regexEmail = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

            var id = $("#Usuario_Id").val();
            var tipo = $('#Usuario_Tipo').val();
            var nome = $("#Usuario_Nome").val();
            var celular = $("#Usuario_Celular").val();
            var CpfCnpj = $("#Usuario_CpfCnpj").val();
            var enderecoCep = $("#Usuario_EnderecoCep").val();
            var enderecoLogradouro = $("#Usuario_EnderecoLogradouro").val();
            var enderecoNumero = $("#Usuario_EnderecoNumero").val();
            var enderecoBairro = $("#Usuario_EnderecoBairro").val();
            var enderecoCidade = $("#Usuario_EnderecoCidade").val();
            var enderecoUF = $("#Usuario_EnderecoUF").val();
            var pago = $("#btnPago").bootstrapSwitch('state');
            var anonimo = $("#btnAnonimo").bootstrapSwitch('state');

            if (nome.length < 4 || nome.length > 40)
                return Notify('Preencha o nome ', null, null);

            // apenas para candidato
            if (tipo == "Candidato" && celular.length < 10 || celular.length > 11)
                return Notify('Informe o seu celular ', null, null);

            if (CpfCnpj.length < 6 || CpfCnpj.length > 13)
                return Notify('Informe o seu Cpf/Cnpj ', null, null);

            if (enderecoCep.length != 8 || !(/^[0-9]+$/.test(enderecoCep)))
                return Notify('Informe o seu Cep ', null, null);

            if (enderecoNumero.length < 1)
                return Notify('Informe o número do seu endereço ', null, null);

            if (id == undefined || id == null || id == 0) {
                var email = $('#Usuario_Email').val();
                var senha = $('#Usuario_Senha').val();

                if (!regexEmail.test(email))
                    return Notify('Email inválido ', null, null);

                var itens = { Habilidades: [], Endereco: {} };

                $.each($('#dvHabilidadesLista span'), function (index, value) {
                    itens.Habilidades.push({
                        'Id': value.id.split('_')[1],
                        'Nome': value.innerText
                    });
                });
                
                if (itens.Habilidades == undefined || itens.Habilidades == null || itens.Habilidades.length < 5)
                    return Notify('Adicione 5 habilidades, no mínimo', null, null);

                // Registrar usuário
                $.ajax({
                    url: "../Acesso/Registrar?email=" + email + "&senha=" + senha,                    
                    contentType: 'application/json',
                    dataType: 'json',
                    type: 'get',
                    success: function (data) {
                        if (data.sucesso) {
                            var dados = {
                                grant_type: "password",
                                username: email,
                                password: senha
                            };

                            $.ajax({
                                url: "../api/security/token",
                                type: "POST",
                                data: dados,
                                contentType: 'application/json',
                                success: function (data) {
                                    if (data != null && data.access_token != null) {
                                        localStorage.setItem('token', data.access_token);                                        
                                    }
                                    else {
                                        Notify('Usuário e senha inválidos', null, null, 'danger');
                                    }
                                },
                                error: function (result) {
                                    Notify(result.responseJSON.error_description, null, null, 'danger');
                                }
                            });
                        }
                        else {
                            Notify('Erro ao registrar usuário, informe a equipe de suporte', null, null, 'danger');
                        }
                    },
                    error: function (result) {
                        Notify('Erro ao registrar usuário ' + result, null, null, 'danger');
                    }
                });
            }

            itens.Endereco = {
                'Cep': enderecoCep,
                'Logradouro': enderecoLogradouro,
                'Numero': enderecoNumero,
                'Bairro': enderecoBairro,
                'Cidade': enderecoCidade,
                'UF': enderecoUF,
            };

            // dados pessoais
            var dados =
            {
                'Id': id,
                'Nome': nome,
                'Email': email,
                'Celular': celular,
                'CpfCnpj': CpfCnpj,                
                'Pago': pago,
                'Anonimo': anonimo,
                'Endereco': itens.Endereco,
                'Habilidades': itens.Habilidades,
                'Tipo': tipo,
            };

            usuario = JSON.stringify(dados);            
            var mensagem = ((id != undefined && id != '') ? "Alterado com sucesso" : "Cadastro realizado!");            

            $.ajax({
                url: "../Cadastro/Gravar",
                type: "post",
                data: usuario,
                contentType: 'application/json',
                dataType: 'json',
                beforeSend: setHeader,
                success: function (data) {
                    if (data.sucesso) {
                        $("#Usuario_Id").val(data.usuario.Id);
                        localStorage.setItem("usuario", data.usuario)
                        Notify(mensagem, null, null, 'success');
                        if (data.usuario.Pago) {
                            GerarBoleto();
                            Notify('Você receberá no seu email informações sobre o pagamento', null, null, 'success');
                        }

                        GravarArquivo();
                    }
                    else {
                        Notify('Ocorreu um erro: Informe a equipe de suporte', null, null, 'danger');
                    }
                },
                error: function (result) {
                    Notify('Ocorreu um erro ' + result, null, null, 'danger');
                }
            });
        });
    });

    var form;
    $('#btnAdicionarArquivo').change(function (event) {
        if (event.target.files.length > 0) {
            var arquivo = event.target.files[0];
            var nome = arquivo.name.toLowerCase();
            if (nome.indexOf('.txt') > -1 || nome.indexOf('.doc') > -1 || nome.indexOf('.docx') > -1 || nome.indexOf('.pdf') > -1) {
                form = new FormData();
                form.append('fileUpload', event.target.files[0]);
                GravarArquivo();
            }
            else
                Notify('Permitido apenas arquivos .txt, .pdf, .doc ou .docx ', null, null);
        }
    });

    function GravarArquivo() {
        if (typeof form != 'undefined' && $("#Usuario_Id").val() != null) {
            $.ajax({
                url: "../Cadastro/GravarArquivo?id=" + $("#Usuario_Id").val() + "&tipo=" + $("#Usuario_Tipo").val(),
                data: form,
                processData: false,
                contentType: false,
                type: 'post',
                beforeSend: setHeader,
                success: function (data) {
                    if (data.sucesso) {
                        if (data.arquivo.Tipo == 'Curriculo')
                            data.arquivo.Tipo = 'Currículo';

                        var html = '<div class="form-group col-sm-6" id="arquivo_' + data.arquivo.Id + '">' + data.arquivo.Tipo + ': <br />' +
                                   '<a id="btnArquivo" href="' + data.arquivo.Caminho.replace('~', '') + data.arquivo.Nome + '" download><i class="fa fa-download fa-2x" aria-hidden="true"></i> </a>' +
                                   '<a id="btnExcluir" href="javascript: ExcluirArquivo(' + data.arquivo.Id + ')"><i class="fa fa-trash fa-2x" aria-hidden="true"></i> </a> </div>';
                        $('#dvDownload').append(html);
                        $('#dvUpload').hide();
                    }
                    else {
                        Notify('Erro ao salvar arquivo: Informe a equipe de suporte', null, null, 'danger');
                    }
                },
                error: function (result) {
                    Notify('Erro ao salvar arquivo ' + result, null, null, 'danger');
                }
            });
        }
    }

    function CarregarTodosArquivos(usuarioId) {

        $.ajax({
            url: "../Cadastro/CarregarTodosArquivos/" + usuarioId,
            data: usuario,
            contentType: 'application/json',
            dataType: 'json',
            type: 'get',
            beforeSend: setHeader,
            success: function (data) {
                if (data.sucesso && data.arquivos != null && data.arquivos.length > 0) {
                    var html = '';

                    $.each(data.arquivos, function (index, arquivo) {
                        if (arquivo.Tipo == 'Curriculo')
                            arquivo.Tipo = 'Currículo';

                        html += '<div class="form-group col-sm-6" id="arquivo_' + arquivo.Id + '">' + arquivo.Tipo + ': <br />' +
                                   '<a id="btnArquivo" href="' + arquivo.Caminho.replace('~', '') + arquivo.Nome + '" download><i class="fa fa-download fa-2x" aria-hidden="true"></i> </a>';
                        if (arquivo.Tipo != 'Boleto')
                            html += '<a id="btnExcluir" href="javascript: ExcluirArquivo(' + arquivo.Id + ')"><i class="fa fa-trash fa-2x" aria-hidden="true"></i> </a> ';

                        html += '</div>';
                        $('#dvDownload').html(html);
                    });
                    $('#dvUpload').hide();
                }
            },
            error: function (result) {
                Notify('Não foi possível carregar o arquivo ' + result, null, null, 'danger');
            }
        });
    }

    function ExcluirArquivo(id) {
        if ($("#Usuario_Id").val() > 0) {
            $.ajax({
                url: "../Cadastro/ExcluirArquivo/" + id,
                data: usuario,
                contentType: 'application/json',
                dataType: 'json',
                type: 'get',
                beforeSend: setHeader,
                success: function (data) {
                    if (data.sucesso) {
                        $('#arquivo_' + id).remove();
                        $('#btnAdicionarArquivo').filestyle('clear');
                        $('#dvUpload').fadeIn();
                        Notify('Arquivo excluído!', null, null, 'success');
                    }
                    else {
                        Notify('Erro ao excluir arquivo: Informe a equipe de suporte', null, null, 'danger');
                    }
                },
                error: function (result) {
                    Notify('Erro ao salvar arquivo ' + result, null, null, 'danger');
                }
            });
        }
    }

    function GerarBoleto() {
        if ($("#Usuario_Id").val() > 0) {
            $.ajax({
                url: "../Cadastro/GerarBoleto",
                data: usuario,
                contentType: 'application/json',
                dataType: 'json',
                type: 'post',
                beforeSend: setHeader,
                success: function (data) {
                    if (data.sucesso) {
                        $('#dvDownloadBoleto a').attr('href', data.url.replace('~', ''));
                        $('#dvDownloadBoleto').fadeIn();
                        $('#dvUpload').hide();
                    }
                    else {
                        Notify('Erro ao salvar arquivo: Informe a equipe de suporte', null, null, 'danger');
                    }
                },
                error: function (result) {
                    Notify('Erro ao salvar arquivo ' + result, null, null, 'danger');
                }
            });
        }
    }
</script>
